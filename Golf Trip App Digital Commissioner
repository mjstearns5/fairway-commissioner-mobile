import React, { useState, useEffect, useMemo } from 'react';
import { 
  Trophy, 
  Calendar, 
  DollarSign, 
  Users, 
  Plus, 
  Trash2, 
  Plane, 
  Home, 
  Flag, 
  Save, 
  RefreshCw,
  ChevronRight,
  TrendingUp,
  TrendingDown,
  Activity,
  UserPlus,
  CheckCircle,
  Menu,
  X,
  Shield,
  User,
  Edit2,
  Check,
  Mail,
  Lock,
  LogOut,
  MapPin,
  Copy,
  ArrowRight,
  Globe,
  Car,
  LogIn,
  Loader2, 
  CreditCard,
  ShoppingBag,
  UserCircle, // Added for Profile Icon
  AlertTriangle // Added for Cancel Sub warning
} from 'lucide-react';
import { initializeApp } from "firebase/app";
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  sendPasswordResetEmail
} from "firebase/auth";
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  onSnapshot, 
  addDoc, 
  deleteDoc, 
  updateDoc,
  query,
  orderBy,
  getDoc
} from "firebase/firestore";

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Constants for Collections ---
const COLLECTIONS = {
  PLAYERS: 'fc_players',
  MATCHES: 'fc_matches',
  ITINERARY: 'fc_itinerary',
  EXPENSES: 'fc_expenses',
  BETS: 'fc_bets',
  SETTINGS: 'fc_settings',
  USERS: 'fc_users' // New collection for user profiles/subscriptions
};

// ----------------------------------------------------------------------
// STRIPE CONFIGURATION & LOADER
// ----------------------------------------------------------------------
const STRIPE_PUBLISHABLE_KEY = 'pk_test_YOUR_PUBLISHABLE_KEY_HERE';

// Custom Stripe Loader Helper to avoid npm dependency issues
const loadStripe = (publishableKey) => {
  if (window.Stripe) {
    return Promise.resolve(window.Stripe(publishableKey));
  }
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://js.stripe.com/v3/';
    script.async = true;
    script.onload = () => {
      if (window.Stripe) {
        resolve(window.Stripe(publishableKey));
      } else {
        reject(new Error('Stripe.js failed to load'));
      }
    };
    script.onerror = () => reject(new Error('Stripe.js failed to load'));
    document.body.appendChild(script);
  });
};

// Initialize Stripe promise
const stripePromise = loadStripe(STRIPE_PUBLISHABLE_KEY);

// --- Components ---

// 1. Subscription Modal (New)
const SubscriptionModal = ({ isOpen, onClose, onSuccess }) => {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');
  const [step, setStep] = useState('info'); // info | payment

  if (!isOpen) return null;

  const handleSubscribe = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');

    try {
      console.log('Initiating subscription flow...');
      
      // MOCK BACKEND CALL
      // In production, this would fetch('/api/create-checkout-session')
      const mockSessionResponse = {
        ok: true,
        json: async () => ({ sessionId: 'mock_session_id_123' })
      };
      
      // Simulate network delay
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      const response = mockSessionResponse;

      if (!response.ok) {
        throw new Error('Failed to create checkout session.');
      }

      const session = await response.json();

      // SIMULATE STRIPE REDIRECT
      // In production, use: const stripe = await stripePromise; stripe.redirectToCheckout(...)
      console.log('Redirecting to Stripe Checkout with session:', session.sessionId);
      
      // Since we can't actually redirect in this demo without a real key, we simulate success
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      onSuccess(); // Trigger the success callback (create trip)
      onClose();

    } catch (err) {
      console.error(err);
      setError(err.message);
      setIsLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
      <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in zoom-in duration-200">
        
        {/* Header */}
        <div className="bg-slate-900 p-6 text-white text-center relative overflow-hidden">
          <div className="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full blur-3xl -mr-8 -mt-8"></div>
          <div className="relative z-10">
            <h2 className="text-2xl font-bold">Upgrade to Commissioner</h2>
            <p className="text-slate-400 text-sm mt-1">Unlock unlimited trip management</p>
          </div>
          <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white">
            <X className="w-5 h-5" />
          </button>
        </div>

        <div className="p-8">
          {step === 'info' ? (
            <div className="space-y-6">
              <div className="text-center">
                <div className="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Trophy className="w-8 h-8" />
                </div>
                <h3 className="text-lg font-bold text-slate-800">Become the Commissioner</h3>
                <p className="text-slate-500 text-sm mt-2">
                  Creating a trip requires a pro license. Manage tournaments, expenses, and logistics like a pro.
                </p>
              </div>
              
              <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <div className="flex justify-between items-center mb-1">
                  <span className="font-bold text-slate-700">Annual License</span>
                  <span className="font-bold text-emerald-600">$15.00 <span className="text-xs text-slate-400 font-normal">/ year</span></span>
                </div>
                <div className="text-xs text-slate-400">Cancel anytime.</div>
              </div>

              <button 
                onClick={() => setStep('payment')}
                className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2"
              >
                Proceed to Payment <ArrowRight className="w-4 h-4" />
              </button>
            </div>
          ) : (
            <form onSubmit={handleSubscribe} className="space-y-6">
              <div className="space-y-4">
                <div>
                  <label className="block text-xs font-bold text-slate-500 uppercase mb-1">
                    Card Information
                  </label>
                  <div className="relative">
                    <CreditCard className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                    <input
                      type="text"
                      className="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition-all"
                      placeholder="0000 0000 0000 0000"
                      disabled={isLoading}
                    />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <input
                    type="text"
                    className="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
                    placeholder="MM / YY"
                    disabled={isLoading}
                  />
                  <input
                    type="text"
                    className="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
                    placeholder="CVC"
                    disabled={isLoading}
                  />
                </div>
              </div>

              {error && (
                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-start gap-2">
                  <span className="font-bold">Error:</span> {error}
                </div>
              )}

              <button
                type="submit"
                disabled={isLoading}
                className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
              >
                {isLoading ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    Processing...
                  </>
                ) : (
                  <>
                    Pay $15.00 & Create Trip
                    <CheckCircle className="w-5 h-5" />
                  </>
                )}
              </button>
              
              <button 
                type="button"
                onClick={() => setStep('info')}
                className="w-full text-sm text-slate-400 hover:text-slate-600"
                disabled={isLoading}
              >
                Back
              </button>
            </form>
          )}
        </div>
        <div className="bg-slate-50 p-3 text-center border-t border-slate-100">
          <p className="text-[10px] text-slate-400 flex items-center justify-center gap-1">
            <Lock className="w-3 h-3" /> Secure Payment via Stripe
          </p>
        </div>
      </div>
    </div>
  );
};

// 2. Auth Screen (New Landing Page)
const AuthScreen = () => {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await createUserWithEmailAndPassword(auth, email, password);
      }
      // Successful auth will trigger onAuthStateChanged in App component
    } catch (err) {
      if (err.code === 'auth/operation-not-allowed') {
        try {
          await signInAnonymously(auth);
        } catch (anonErr) {
          setError("Demo login failed. Please reload.");
          setLoading(false);
        }
      } else {
        setError(err.message.replace('Firebase: ', ''));
        setLoading(false);
      }
    }
  };

  return (
    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans">
      <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col">
        {/* Header */}
        <div className="bg-emerald-800 p-8 text-center">
          <div className="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
            <Flag className="w-8 h-8 text-yellow-400 fill-current" />
          </div>
          <h1 className="text-3xl font-bold text-white tracking-tight">Fairway Commish</h1>
          <p className="text-emerald-200 mt-2 text-sm">
            {isLogin ? 'Welcome back, Commissioner.' : 'Your trip starts here.'}
          </p>
        </div>

        {/* Form */}
        <div className="p-8 flex-1">
          <form onSubmit={handleSubmit} className="space-y-5">
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Email Address</label>
              <div className="relative">
                <Mail className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                <input 
                  type="email" 
                  required
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition-all" 
                  placeholder="name@example.com"
                />
              </div>
            </div>
            
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
              <div className="relative">
                <Lock className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                <input 
                  type="password" 
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition-all" 
                  placeholder="••••••••"
                />
              </div>
            </div>

            {error && (
              <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-start gap-2">
                <span className="font-bold">Error:</span> {error}
              </div>
            )}

            <button 
              type="submit" 
              disabled={loading}
              className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg transition-all shadow-lg shadow-emerald-200/50 disabled:opacity-70 disabled:cursor-not-allowed flex justify-center items-center gap-2"
            >
              {loading ? 'Processing...' : (isLogin ? 'Log In' : 'Create Account')}
              {!loading && <ArrowRight className="w-5 h-5" />}
            </button>
          </form>

          {/* Toggle */}
          <div className="mt-8 pt-6 border-t border-slate-100 text-center">
            <p className="text-sm text-slate-500 mb-3">
              {isLogin ? "Don't have an account?" : "Already have an account?"}
            </p>
            <button 
              onClick={() => { setIsLogin(!isLogin); setError(''); }}
              className="text-emerald-700 font-bold hover:text-emerald-900 hover:underline transition-colors"
            >
              {isLogin ? 'Create an Account' : 'Log In with Email'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// 3. User Profile View (New)
const UserProfileView = ({ user, isSubscribed }) => {
  const [resetSent, setResetSent] = useState(false);
  const [cancelling, setCancelling] = useState(false);

  const handlePasswordReset = async () => {
    try {
      await sendPasswordResetEmail(auth, user.email);
      setResetSent(true);
    } catch (error) {
      console.error("Error sending reset email", error);
    }
  };

  const handleCancelSubscription = async () => {
    if (!window.confirm("Are you sure you want to cancel your Commissioner license? You will lose access to creating new trips.")) return;
    
    setCancelling(true);
    try {
      const validAppId = typeof appId === 'string' ? appId : 'default-app-id';
      // Set isPro to false in database
      await setDoc(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.USERS, user.uid), { 
        isPro: false,
        updatedAt: new Date().toISOString()
      }, { merge: true });
    } catch (error) {
      console.error("Error cancelling subscription", error);
    } finally {
      setCancelling(false);
    }
  };

  return (
    <div className="max-w-2xl mx-auto pt-8 space-y-8">
      <div className="flex items-center gap-4 border-b border-slate-200 pb-6">
        <div className="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center text-slate-500">
          <UserCircle className="w-10 h-10" />
        </div>
        <div>
          <h2 className="text-2xl font-bold text-slate-800">My Profile</h2>
          <p className="text-slate-500 text-sm">Manage your account settings and subscription.</p>
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="p-6 space-y-6">
          
          {/* Account Info */}
          <div className="space-y-4">
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wide">Account Details</h3>
            
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 py-2 border-b border-slate-100">
              <div>
                <label className="block text-xs text-slate-500 mb-1">Email Address</label>
                <div className="font-medium text-slate-800">{user.email}</div>
              </div>
            </div>

            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 py-2 border-b border-slate-100">
              <div>
                <label className="block text-xs text-slate-500 mb-1">Password</label>
                <div className="font-mono text-slate-800 tracking-widest text-sm flex items-center gap-2">
                  <Lock className="w-3 h-3 text-slate-400" /> ••••••••
                </div>
              </div>
              <div>
                {resetSent ? (
                  <span className="text-xs font-bold text-emerald-600 flex items-center gap-1">
                    <Check className="w-3 h-3" /> Reset Email Sent
                  </span>
                ) : (
                  <button 
                    onClick={handlePasswordReset}
                    className="text-xs font-bold text-blue-600 hover:underline bg-blue-50 px-3 py-1.5 rounded-lg"
                  >
                    Reset Password
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* Subscription Info */}
          <div className="space-y-4 pt-4">
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wide">Subscription</h3>
            
            <div className="bg-slate-50 rounded-xl p-4 border border-slate-200">
              <div className="flex justify-between items-start">
                <div className="flex gap-3">
                  <div className={`p-2 rounded-lg ${isSubscribed ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'}`}>
                    <Trophy className="w-5 h-5" />
                  </div>
                  <div>
                    <h4 className="font-bold text-slate-800">Commissioner License</h4>
                    <p className="text-sm text-slate-500">
                      {isSubscribed 
                        ? 'Active • Annual Plan ($15.00/yr)' 
                        : 'Inactive • Free Tier'}
                    </p>
                  </div>
                </div>
                {isSubscribed && (
                  <div className="flex items-center gap-1 bg-emerald-100 text-emerald-700 text-xs font-bold px-2 py-1 rounded-full">
                    <CheckCircle className="w-3 h-3" /> Active
                  </div>
                )}
              </div>

              {isSubscribed && (
                <div className="mt-4 pt-4 border-t border-slate-200 flex justify-end">
                  <button 
                    onClick={handleCancelSubscription}
                    disabled={cancelling}
                    className="text-xs font-bold text-red-500 hover:text-red-700 flex items-center gap-1 disabled:opacity-50"
                  >
                    {cancelling ? (
                      <>Processing...</>
                    ) : (
                      <>Cancel Subscription <AlertTriangle className="w-3 h-3" /></>
                    )}
                  </button>
                </div>
              )}
            </div>
          </div>

        </div>
      </div>
    </div>
  );
};

// 4. Navigation & Layout
const Layout = ({ children, view, setView, user, role, setRole, tripId, setTripId, handleLogout }) => {
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  const navItems = [
    { id: 'setup', label: 'Trip Setup', icon: MapPin },
    { id: 'dashboard', label: 'Dashboard', icon: Activity },
    { id: 'tournament', label: 'Tournament', icon: Trophy },
    { id: 'booking', label: 'Book Rounds', icon: Globe },
    { id: 'travel', label: 'Stays/Transport', icon: Car },
    { id: 'merch', label: 'Team Merch', icon: ShoppingBag }, // New Tab Added
    { id: 'logistics', label: 'Logistics', icon: Calendar },
    { id: 'finance', label: 'The Ledger', icon: DollarSign },
    { id: 'players', label: 'Roster', icon: Users },
  ];

  // Filter nav items based on if a trip is selected
  const visibleNavItems = tripId 
    ? navItems 
    : navItems.filter(i => i.id === 'setup');

  const handleExitTrip = () => {
    setTripId(null);
    setView('setup');
    setRole('player'); // Reset role on exit
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans">
      {/* Mobile Header */}
      <div className="bg-emerald-800 text-white p-4 shadow-md sticky top-0 z-50">
        <div className="flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Flag className="w-6 h-6 text-yellow-400 fill-current" />
            <h1 className="text-xl font-bold tracking-tight">Fairway Commish</h1>
          </div>
          
          <div className="flex items-center gap-4">
            {/* Desktop User Info & Profile Icon */}
            <div className="hidden md:flex items-center gap-4">
               <div className="text-right">
                  <div className="text-[10px] text-emerald-300 uppercase font-bold tracking-wider">Signed In As</div>
                  <div className="text-xs font-bold text-white">{user?.email || 'Guest Commissioner'}</div>
               </div>
               
               <button 
                 onClick={() => setView('profile')}
                 className={`p-2 rounded-full transition-colors ${view === 'profile' ? 'bg-emerald-900 text-white shadow-inner' : 'text-emerald-100 hover:bg-emerald-700 hover:text-white'}`}
                 title="My Profile"
               >
                 <UserCircle className="w-6 h-6" />
               </button>

               <button onClick={handleLogout} className="text-emerald-100 hover:text-white text-sm font-medium flex items-center gap-1 ml-2 border-l border-emerald-700 pl-4">
                 <LogOut className="w-4 h-4" /> Sign Out
               </button>
            </div>

            <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="md:hidden text-emerald-100 hover:text-white">
              {isMenuOpen ? <X /> : <Menu />}
            </button>
          </div>
        </div>
      </div>

      {/* Mobile Menu */}
      {isMenuOpen && (
        <div className="md:hidden bg-emerald-900 text-white p-4 space-y-2 fixed w-full z-40 shadow-xl border-t border-emerald-800 overflow-y-auto max-h-[calc(100vh-80px)]">
           {/* Mobile User Info */}
           <div className="bg-emerald-950/30 p-3 rounded-lg mb-4 flex justify-between items-center">
              <div className="flex items-center gap-3">
                 <div onClick={() => { setView('profile'); setIsMenuOpen(false); }} className="bg-emerald-800 p-2 rounded-full cursor-pointer">
                    <UserCircle className="w-5 h-5 text-emerald-100" />
                 </div>
                 <div className="text-xs text-emerald-200 truncate max-w-[150px]">{user?.email || 'Guest Commissioner'}</div>
              </div>
              <button onClick={handleLogout} className="text-xs font-bold bg-emerald-800 px-2 py-1 rounded">Sign Out</button>
           </div>

           {/* Trip Code Display (Mobile) */}
           {tripId && (
             <div className="bg-emerald-800 p-3 rounded-lg mb-4 flex justify-between items-center">
                <div>
                  <div className="text-xs text-emerald-300 uppercase font-bold">Current Trip</div>
                  <div className="font-mono font-bold text-lg tracking-wider">{tripId}</div>
                </div>
                <button onClick={handleExitTrip} className="bg-emerald-900/50 p-2 rounded text-emerald-200">
                  <LogOut className="w-4 h-4" />
                </button>
             </div>
           )}

           {/* Mobile Role Switcher */}
           {tripId && (
             <div className="bg-emerald-800 p-3 rounded-lg mb-4 flex gap-2">
                <button 
                  onClick={() => setRole('commissioner')}
                  className={`flex-1 py-1 text-xs font-bold rounded ${role === 'commissioner' ? 'bg-yellow-400 text-emerald-900' : 'text-emerald-200'}`}
                >
                  Commissioner
                </button>
                <button 
                  onClick={() => setRole('player')}
                  className={`flex-1 py-1 text-xs font-bold rounded ${role === 'player' ? 'bg-white text-emerald-900' : 'text-emerald-200'}`}
                >
                  Player
                </button>
             </div>
           )}

          {visibleNavItems.map((item) => (
            <button
              key={item.id}
              onClick={() => { setView(item.id); setIsMenuOpen(false); }}
              className={`flex items-center gap-3 w-full p-3 rounded-lg ${view === item.id ? 'bg-emerald-700' : 'hover:bg-emerald-800'}`}
            >
              <item.icon className="w-5 h-5" />
              <span className="font-medium">{item.label}</span>
            </button>
          ))}
        </div>
      )}

      <div className="flex max-w-6xl mx-auto">
        {/* Desktop Sidebar */}
        <div className="hidden md:block w-64 bg-white min-h-[calc(100vh-64px)] shadow-lg border-r border-slate-200 p-4 sticky top-16 h-fit">
          <div className="space-y-6">
            
            {/* Trip Context Card */}
            {tripId ? (
              <div className="bg-slate-900 rounded-xl p-4 text-white relative overflow-hidden group">
                <div className="relative z-10">
                  <div className="text-xs text-slate-400 font-bold uppercase mb-1">Trip Code</div>
                  <div className="text-2xl font-mono font-bold text-emerald-400 tracking-wider flex items-center gap-2">
                    {tripId}
                    <Copy 
                      className="w-4 h-4 text-slate-500 cursor-pointer hover:text-white" 
                      onClick={() => navigator.clipboard.writeText(tripId)}
                    />
                  </div>
                  <div className="mt-3 pt-3 border-t border-slate-800 flex justify-between items-center">
                    <span className="text-xs text-slate-400">
                      {role === 'commissioner' ? 'Admin Mode' : 'View Mode'}
                    </span>
                    <button onClick={handleExitTrip} className="text-xs text-red-400 hover:text-red-300 font-bold flex items-center gap-1">
                      Exit <LogOut className="w-3 h-3" />
                    </button>
                  </div>
                </div>
                {/* Role Switcher (Debug/Demo Purposes) */}
                <div className="mt-4 bg-slate-800 p-1 rounded-lg flex text-[10px] font-bold">
                   <button onClick={() => setRole('commissioner')} className={`flex-1 py-1 rounded ${role === 'commissioner' ? 'bg-emerald-600 text-white' : 'text-slate-400'}`}>Commish</button>
                   <button onClick={() => setRole('player')} className={`flex-1 py-1 rounded ${role === 'player' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>Player</button>
                </div>
              </div>
            ) : (
              <div className="bg-slate-100 rounded-xl p-4 text-center">
                <MapPin className="w-8 h-8 text-slate-300 mx-auto mb-2" />
                <p className="text-sm text-slate-500 font-medium">No Active Trip</p>
              </div>
            )}

            <div className="space-y-2">
              <div className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 px-3">Menu</div>
              {visibleNavItems.map((item) => (
                <button
                  key={item.id}
                  onClick={() => setView(item.id)}
                  className={`flex items-center gap-3 w-full p-3 rounded-lg transition-all ${view === item.id ? 'bg-emerald-50 text-emerald-700 font-semibold shadow-sm border border-emerald-100' : 'text-slate-600 hover:bg-slate-50'}`}
                >
                  <item.icon className="w-5 h-5" />
                  <span>{item.label}</span>
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Main Content */}
        <main className="flex-1 p-4 md:p-8 overflow-x-hidden">
          {children}
        </main>
      </div>
    </div>
  );
};

// 5. Trip Setup View
const TripSetupView = ({ setTripId, setRole, setView, user, isSubscribed }) => {
  const [joinCode, setJoinCode] = useState('');
  const [showSubscription, setShowSubscription] = useState(false);

  // Database helper for enabling subscription
  const enableSubscription = async () => {
    // Write { isPro: true } to artifacts/{appId}/public/data/fc_users/{uid}
    const validAppId = typeof appId === 'string' ? appId : 'default-app-id';
    await setDoc(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.USERS, user.uid), { 
      isPro: true,
      email: user.email,
      updatedAt: new Date().toISOString()
    }, { merge: true });
  };

  const finalizeCreateTrip = () => {
    // Generate a random 6-char code
    const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
    setTripId(newCode);
    setRole('commissioner');
    setView('dashboard'); // Auto-navigate
  };

  const handleCreateTrip = () => {
    if (isSubscribed) {
      finalizeCreateTrip();
    } else {
      setShowSubscription(true);
    }
  };

  const onPaymentSuccess = async () => {
    await enableSubscription();
    finalizeCreateTrip();
  };

  const handleJoinTrip = (e) => {
    e.preventDefault();
    if (joinCode.length < 3) return;
    setTripId(joinCode.toUpperCase());
    setRole('player');
    setView('dashboard'); // Auto-navigate
  };

  return (
    <>
      <SubscriptionModal 
        isOpen={showSubscription} 
        onClose={() => setShowSubscription(false)} 
        onSuccess={onPaymentSuccess} 
      />
      <div className="max-w-2xl mx-auto pt-8 space-y-8">
        <div className="text-center space-y-2">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-emerald-100 rounded-full text-emerald-600 mb-4">
            <MapPin className="w-8 h-8" />
          </div>
          <h2 className="text-3xl font-bold text-slate-800">Fairway Commish</h2>
          <p className="text-slate-500">The ultimate Ryder Cup style trip manager.</p>
        </div>

        <div className="grid md:grid-cols-2 gap-6">
          {/* Create Trip Card */}
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:border-emerald-500 transition-all group cursor-pointer flex flex-col" onClick={handleCreateTrip}>
            <div className="flex-1">
              <div className="bg-emerald-50 w-10 h-10 rounded-lg flex items-center justify-center text-emerald-600 mb-4">
                <Plus className="w-6 h-6" />
              </div>
              <h3 className="text-xl font-bold text-slate-800 mb-2">Create a Trip</h3>
              <p className="text-slate-500 text-sm">Start a new adventure. You will be assigned as the Commissioner.</p>
            </div>
            <div className="mt-6 flex items-center text-emerald-600 font-bold text-sm group-hover:translate-x-1 transition-transform">
              {isSubscribed ? (
                <>Generate Code <ArrowRight className="w-4 h-4 ml-1" /></>
              ) : (
                <>Unlock Pro <Lock className="w-3 h-3 ml-1" /></>
              )}
            </div>
          </div>

          {/* Join Trip Card */}
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div className="bg-blue-50 w-10 h-10 rounded-lg flex items-center justify-center text-blue-600 mb-4">
              <Users className="w-6 h-6" />
            </div>
            <h3 className="text-xl font-bold text-slate-800 mb-2">Enter a Trip</h3>
            <p className="text-slate-500 text-sm mb-4">Join an existing group using their unique trip code.</p>
            
            <form onSubmit={handleJoinTrip} className="flex gap-2">
              <input 
                type="text" 
                value={joinCode}
                onChange={(e) => setJoinCode(e.target.value.toUpperCase())}
                placeholder="ENTER CODE" 
                className="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 font-mono font-bold text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase"
                maxLength={6}
              />
              <button disabled={!joinCode} className="bg-slate-900 text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-800 disabled:opacity-50">
                Join
              </button>
            </form>
          </div>
        </div>
      </div>
    </>
  );
};

// 6. Book Rounds View (Placeholder)
const BookRoundsView = () => {
  return (
    <div className="flex flex-col items-center justify-center h-96 text-center space-y-4">
      <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center">
        <Globe className="w-10 h-10 text-slate-400" />
      </div>
      <div>
        <h3 className="text-2xl font-bold text-slate-700">Book Rounds</h3>
        <p className="text-slate-500 max-w-sm mx-auto mt-2">
          Search and book tee times directly from the app. Integration with booking providers is coming soon.
        </p>
      </div>
    </div>
  );
};

// 7. Stays/Transport View (Placeholder)
const StaysTransportView = () => {
  return (
    <div className="flex flex-col items-center justify-center h-96 text-center space-y-4">
      <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center">
        <Car className="w-10 h-10 text-slate-400" />
      </div>
      <div>
        <h3 className="text-2xl font-bold text-slate-700">Stays & Transport</h3>
        <p className="text-slate-500 max-w-sm mx-auto mt-2">
          Book hotels, rental cars, and shuttles for your group. Integration with travel partners coming soon.
        </p>
      </div>
    </div>
  );
};

// 8. Team Merch View (New Placeholder Component)
const TeamMerchView = () => {
  return (
    <div className="flex flex-col items-center justify-center h-96 text-center space-y-4">
      <div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center">
        <ShoppingBag className="w-10 h-10 text-slate-400" />
      </div>
      <div>
        <h3 className="text-2xl font-bold text-slate-700">Team Merch</h3>
        <p className="text-slate-500 max-w-sm mx-auto mt-2">
          Order custom polos, hats, and gear for your trip. Store integration coming soon.
        </p>
      </div>
    </div>
  );
};

// 9. Roster Management
const RosterView = ({ players, addPlayer, deletePlayer, updatePlayer, role, teamNames }) => {
  const [newName, setNewName] = useState('');
  const [newHcp, setNewHcp] = useState('');

  const handleAdd = (e) => {
    e.preventDefault();
    if (!newName) return;
    addPlayer({ name: newName, handicap: parseFloat(newHcp) || 0, team: 'Unassigned' });
    setNewName('');
    setNewHcp('');
  };

  const autoBalanceTeams = () => {
    const sorted = [...players].sort((a, b) => b.handicap - a.handicap);
    sorted.forEach((p, i) => {
      const remainder = i % 4;
      const newTeam = (remainder === 0 || remainder === 3) ? 'Red' : 'Blue';
      if (p.team !== newTeam) {
        updatePlayer(p.id, { team: newTeam });
      }
    });
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-slate-800">Trip Roster</h2>
        <div className="flex gap-2">
           {role === 'commissioner' && (
             <button 
               onClick={autoBalanceTeams}
               className="flex items-center gap-2 bg-white border border-slate-300 text-slate-600 px-3 py-1 rounded-full text-sm font-medium hover:bg-slate-50 transition-colors"
             >
               <RefreshCw className="w-4 h-4" /> Auto-Balance Teams
             </button>
           )}
           <span className="bg-slate-200 text-slate-700 px-3 py-1 rounded-full text-sm font-medium flex items-center">{players.length} Golfers</span>
        </div>
      </div>

      {role === 'commissioner' && (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
          <form onSubmit={handleAdd} className="flex flex-col md:flex-row gap-4 items-end">
            <div className="flex-1 w-full">
              <label className="block text-sm font-medium text-slate-600 mb-1">Player Name</label>
              <input 
                type="text" 
                value={newName} 
                onChange={(e) => setNewName(e.target.value)} 
                className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-emerald-500 outline-none" 
                placeholder="e.g. Tiger Woods"
              />
            </div>
            <div className="w-full md:w-32">
              <label className="block text-sm font-medium text-slate-600 mb-1">Handicap</label>
              <input 
                type="number" 
                value={newHcp} 
                onChange={(e) => setNewHcp(e.target.value)} 
                className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-emerald-500 outline-none" 
                placeholder="0.0"
                step="0.1"
              />
            </div>
            <button type="submit" className="w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white p-2 px-6 rounded font-medium transition-colors">
              Add
            </button>
          </form>
        </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {players.map(player => (
          <div key={player.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center group">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold">
                {player.name.charAt(0)}
              </div>
              <div>
                <h3 className="font-semibold text-slate-800">{player.name}</h3>
                <p className="text-xs text-slate-500">HCP: {player.handicap}</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
               <select 
                value={player.team} 
                disabled={role !== 'commissioner'}
                onChange={(e) => updatePlayer(player.id, { team: e.target.value })}
                className={`text-xs font-bold px-2 py-1 rounded border-none focus:ring-0 ${role === 'commissioner' ? 'cursor-pointer' : 'cursor-default pointer-events-none'} ${
                  player.team === 'Red' ? 'text-red-600 bg-red-50' : 
                  player.team === 'Blue' ? 'text-blue-600 bg-blue-50' : 'text-slate-500 bg-slate-100'
                }`}
               >
                 <option value="Unassigned">No Team</option>
                 <option value="Red">{teamNames.red}</option>
                 <option value="Blue">{teamNames.blue}</option>
               </select>
              {role === 'commissioner' && (
                <button onClick={() => deletePlayer(player.id)} className="text-slate-300 hover:text-red-500 p-1">
                  <Trash2 className="w-4 h-4" />
                </button>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// 10. Tournament Engine
const TournamentView = ({ players, matches, updateMatch, addMatch, deleteMatch, role, teamNames, updateTeamNames }) => {
  const [activeTab, setActiveTab] = useState('matchups');
  const [isEditingNames, setIsEditingNames] = useState(false);
  const [tempNames, setTempNames] = useState(teamNames);
  
  const scores = useMemo(() => {
    let red = 0;
    let blue = 0;
    matches.forEach(m => {
      if (m.winner === 'Red') red += 1;
      else if (m.winner === 'Blue') blue += 1;
      else if (m.winner === 'Halved') { red += 0.5; blue += 0.5; }
    });
    return { red, blue };
  }, [matches]);

  const isCommish = role === 'commissioner';

  const handleSaveNames = () => {
    updateTeamNames(tempNames);
    setIsEditingNames(false);
  };

  return (
    <div className="space-y-6">
      {/* Scoreboard Header */}
      <div className="bg-slate-900 rounded-2xl p-6 text-white shadow-lg overflow-hidden relative group">
        <div className="absolute top-0 right-0 w-64 h-64 bg-emerald-500/10 rounded-full blur-3xl -mr-16 -mt-16"></div>
        
        {isCommish && (
          <div className="absolute top-4 right-4 z-20">
            {isEditingNames ? (
              <button onClick={handleSaveNames} className="bg-emerald-600 text-white p-2 rounded-full hover:bg-emerald-500 transition-colors">
                <Check className="w-4 h-4" />
              </button>
            ) : (
              <button onClick={() => setIsEditingNames(true)} className="bg-slate-800 text-slate-400 p-2 rounded-full hover:bg-slate-700 hover:text-white transition-colors">
                <Edit2 className="w-4 h-4" />
              </button>
            )}
          </div>
        )}

        <div className="relative z-10 flex justify-between items-center text-center">
          <div className="flex-1">
            {isEditingNames ? (
              <input 
                value={tempNames.red}
                onChange={(e) => setTempNames({...tempNames, red: e.target.value})}
                className="bg-transparent text-red-400 font-bold uppercase tracking-wider text-sm mb-1 text-center border-b border-red-500/50 focus:outline-none focus:border-red-400 w-full"
                placeholder="Red Team Name"
              />
            ) : (
              <h3 className="text-red-400 font-bold uppercase tracking-wider text-sm mb-1">{teamNames.red}</h3>
            )}
            <div className="text-5xl font-black">{scores.red}</div>
          </div>
          <div className="px-4">
            <div className="text-2xl font-serif italic text-slate-400">vs</div>
          </div>
          <div className="flex-1">
             {isEditingNames ? (
              <input 
                value={tempNames.blue}
                onChange={(e) => setTempNames({...tempNames, blue: e.target.value})}
                className="bg-transparent text-blue-400 font-bold uppercase tracking-wider text-sm mb-1 text-center border-b border-blue-500/50 focus:outline-none focus:border-blue-400 w-full"
                placeholder="Blue Team Name"
              />
            ) : (
              <h3 className="text-blue-400 font-bold uppercase tracking-wider text-sm mb-1">{teamNames.blue}</h3>
            )}
            <div className="text-5xl font-black">{scores.blue}</div>
          </div>
        </div>
      </div>

      {/* Controls */}
      <div className="flex justify-between items-center">
        <div className="flex gap-2">
          <button 
            className="px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-emerald-600 text-white"
          >
            Active Matchups
          </button>
        </div>
        {isCommish && (
           <button 
             onClick={() => addMatch({ 
               day: 'Day 1', 
               format: 'Fourball', 
               redPlayers: '', 
               bluePlayers: '', 
               winner: 'Pending',
               status: 'All Square'
             })}
             className="px-4 py-2 rounded-full text-sm font-medium bg-white text-slate-600 border flex items-center gap-2 hover:bg-slate-50"
          >
            <Plus className="w-4 h-4" /> Add Match
          </button>
        )}
      </div>

      {/* Match Cards */}
      <div className="space-y-4">
        {matches.map((match) => (
          <div key={match.id} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div className="bg-slate-50 p-3 border-b border-slate-200 flex justify-between items-center">
              <div className="flex items-center gap-2">
                <input 
                  value={match.day}
                  disabled={!isCommish}
                  onChange={(e) => updateMatch(match.id, { day: e.target.value })}
                  className={`text-xs font-bold text-slate-500 uppercase tracking-wide bg-transparent border-none focus:ring-0 p-0 w-16 ${!isCommish && 'cursor-default'}`}
                />
                <span className="text-slate-300">•</span>
                <select 
                  value={match.format}
                  disabled={!isCommish}
                  onChange={(e) => updateMatch(match.id, { format: e.target.value })}
                  className={`text-xs font-bold text-slate-700 uppercase tracking-wide bg-transparent border-none focus:ring-0 p-0 ${isCommish ? 'cursor-pointer' : 'cursor-default appearance-none'}`}
                >
                  <option value="Fourball">Fourball</option>
                  <option value="Alternate Shot">Alternate Shot</option>
                  <option value="Singles">Singles</option>
                  <option value="Match Play">Match Play</option>
                  <option value="Stableford">Stableford</option>
                  <option value="Worst Ball">Worst Ball</option>
                </select>
              </div>
              {isCommish && (
                <button onClick={() => deleteMatch(match.id)} className="text-slate-400 hover:text-red-500">
                  <Trash2 className="w-4 h-4" />
                </button>
              )}
            </div>
            <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
              {/* Red Team Side */}
              <div className="bg-red-50 p-3 rounded-lg border border-red-100 relative">
                 <div className="absolute -top-2.5 left-2 bg-white px-1 text-[10px] font-bold text-red-400 uppercase tracking-wider">{teamNames.red}</div>
                 <input 
                  type="text" 
                  value={match.redPlayers} 
                  disabled={!isCommish}
                  onChange={(e) => updateMatch(match.id, { redPlayers: e.target.value })}
                  className="w-full bg-transparent font-bold text-red-900 placeholder-red-300 text-center outline-none focus:bg-white rounded disabled:bg-transparent"
                  placeholder={['Singles', 'Match Play'].includes(match.format) ? "Player Name" : "Player A / Player B"}
                 />
              </div>

              {/* Scoring Control */}
              <div className="flex flex-col items-center gap-2">
                <div className="flex items-center gap-2 bg-slate-100 rounded-lg p-1">
                   <button 
                    disabled={!isCommish}
                    onClick={() => updateMatch(match.id, { winner: 'Red' })}
                    className={`px-3 py-1 rounded text-xs font-bold transition-all ${
                      match.winner === 'Red' ? 'bg-red-500 text-white shadow-sm' : 
                      isCommish ? 'text-slate-500 hover:bg-slate-200' : 'text-slate-400 cursor-default'
                    }`}
                   >Red</button>
                   <button 
                    disabled={!isCommish}
                    onClick={() => updateMatch(match.id, { winner: 'Halved' })}
                    className={`px-3 py-1 rounded text-xs font-bold transition-all ${
                      match.winner === 'Halved' ? 'bg-slate-500 text-white shadow-sm' : 
                      isCommish ? 'text-slate-500 hover:bg-slate-200' : 'text-slate-400 cursor-default'
                    }`}
                   >Halved</button>
                   <button 
                    disabled={!isCommish}
                    onClick={() => updateMatch(match.id, { winner: 'Blue' })}
                    className={`px-3 py-1 rounded text-xs font-bold transition-all ${
                      match.winner === 'Blue' ? 'bg-blue-500 text-white shadow-sm' : 
                      isCommish ? 'text-slate-500 hover:bg-slate-200' : 'text-slate-400 cursor-default'
                    }`}
                   >Blue</button>
                </div>
                <input 
                  type="text" 
                  value={match.status} 
                  disabled={!isCommish}
                  onChange={(e) => updateMatch(match.id, { status: e.target.value })}
                  className="text-center text-xs font-medium text-slate-500 bg-transparent outline-none w-full disabled:bg-transparent"
                  placeholder="Match Status"
                />
              </div>

              {/* Blue Team Side */}
              <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 relative">
                 <div className="absolute -top-2.5 right-2 bg-white px-1 text-[10px] font-bold text-blue-400 uppercase tracking-wider">{teamNames.blue}</div>
                <input 
                  type="text" 
                  value={match.bluePlayers} 
                  disabled={!isCommish}
                  onChange={(e) => updateMatch(match.id, { bluePlayers: e.target.value })}
                  className="w-full bg-transparent font-bold text-blue-900 placeholder-blue-300 text-center outline-none focus:bg-white rounded disabled:bg-transparent"
                  placeholder={['Singles', 'Match Play'].includes(match.format) ? "Player Name" : "Player A / Player B"}
                 />
              </div>
            </div>
          </div>
        ))}
        {matches.length === 0 && (
          <div className="text-center py-12 bg-white rounded-xl border border-dashed border-slate-300 text-slate-400">
            <Trophy className="w-12 h-12 mx-auto mb-2 opacity-50" />
            <p>No matches scheduled yet.</p>
          </div>
        )}
      </div>
    </div>
  );
};

// 11. Logistics Hub
const LogisticsView = ({ itinerary, addItinerary, deleteItinerary, role }) => {
  const [form, setForm] = useState({ type: 'Golf', time: '', title: '', location: '' });

  const getIcon = (type) => {
    switch(type) {
      case 'Flight': return <Plane className="w-5 h-5" />;
      case 'Stay': return <Home className="w-5 h-5" />;
      case 'Golf': return <Flag className="w-5 h-5" />;
      default: return <Calendar className="w-5 h-5" />;
    }
  };

  const getColor = (type) => {
     switch(type) {
      case 'Flight': return 'bg-blue-100 text-blue-600';
      case 'Stay': return 'bg-purple-100 text-purple-600';
      case 'Golf': return 'bg-emerald-100 text-emerald-600';
      default: return 'bg-slate-100 text-slate-600';
    }
  };

  const handleAdd = (e) => {
    e.preventDefault();
    if(!form.title) return;
    addItinerary(form);
    setForm({ type: 'Golf', time: '', title: '', location: '' });
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-slate-800">Trip Itinerary</h2>
      </div>

      {role === 'commissioner' && (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
          <h3 className="text-sm font-semibold text-slate-500 uppercase mb-4">Add Event</h3>
          <form onSubmit={handleAdd} className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <select 
              value={form.type} 
              onChange={e => setForm({...form, type: e.target.value})}
              className="p-2 border rounded"
            >
              <option>Golf</option>
              <option>Flight</option>
              <option>Stay</option>
              <option>Dining</option>
              <option>Other</option>
            </select>
            <input 
              type="datetime-local" 
              value={form.time}
              onChange={e => setForm({...form, time: e.target.value})}
              className="p-2 border rounded"
              required
            />
            <input 
              type="text" 
              placeholder="Event Title"
              value={form.title}
              onChange={e => setForm({...form, title: e.target.value})}
              className="p-2 border rounded"
              required
            />
            <input 
              type="text" 
              placeholder="Location/Notes"
              value={form.location}
              onChange={e => setForm({...form, location: e.target.value})}
              className="p-2 border rounded"
            />
            <button className="md:col-span-4 bg-slate-800 text-white p-2 rounded hover:bg-slate-700 font-medium">Add to Itinerary</button>
          </form>
        </div>
      )}

      <div className="relative border-l-2 border-slate-200 ml-4 space-y-8 py-2">
        {itinerary.sort((a,b) => new Date(a.time) - new Date(b.time)).map((item) => (
          <div key={item.id} className="relative pl-8">
            <div className={`absolute -left-[17px] top-0 w-8 h-8 rounded-full border-2 border-white shadow-sm flex items-center justify-center ${getColor(item.type)}`}>
              {getIcon(item.type)}
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 group">
              <div className="flex justify-between items-start">
                <div>
                  <span className="text-xs font-bold text-slate-400 uppercase tracking-wide">
                    {new Date(item.time).toLocaleString([], { weekday: 'short', hour: '2-digit', minute:'2-digit' })}
                  </span>
                  <h4 className="text-lg font-bold text-slate-800">{item.title}</h4>
                  <p className="text-slate-600 text-sm mt-1">{item.location}</p>
                </div>
                {role === 'commissioner' && (
                  <button onClick={() => deleteItinerary(item.id)} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500">
                    <Trash2 className="w-4 h-4" />
                  </button>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// 12. The Ledger (Expenses & Betting)
const LedgerView = ({ players, expenses, bets, addExpense, addBet, deleteItem, role }) => {
  const [view, setView] = useState('summary'); // summary, addExpense, addBet
  const [expenseForm, setExpenseForm] = useState({ payerId: '', amount: '', description: '' });
  const [betForm, setBetForm] = useState({ winnerId: '', loserId: '', amount: '', description: '' });

  // Calculate Net Settlement
  const settlement = useMemo(() => {
    const balances = {};
    players.forEach(p => balances[p.id] = 0);

    // 1. Shared Expenses
    const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
    const perPerson = totalExpenses / (players.length || 1);
    
    expenses.forEach(e => {
      if(balances[e.payerId] !== undefined) {
        balances[e.payerId] += parseFloat(e.amount); // They paid this much
      }
    });
    
    // Subtract fair share from everyone
    players.forEach(p => {
      balances[p.id] -= perPerson;
    });

    // 2. Betting Adjustments
    bets.forEach(b => {
      const amt = parseFloat(b.amount);
      if(balances[b.winnerId] !== undefined) balances[b.winnerId] += amt;
      if(balances[b.loserId] !== undefined) balances[b.loserId] -= amt;
    });

    return Object.entries(balances)
      .map(([id, amount]) => ({ 
        id, 
        name: players.find(p => p.id === id)?.name || 'Unknown', 
        amount 
      }))
      .sort((a,b) => b.amount - a.amount);
  }, [players, expenses, bets]);

  // Calculate Suggested Payments (Who pays Whom)
  const payments = useMemo(() => {
    // Clone lists to avoid mutating display data
    let debtors = settlement.filter(p => p.amount < -0.01).map(p => ({...p}));
    let creditors = settlement.filter(p => p.amount > 0.01).map(p => ({...p}));
    
    // Sort by magnitude to optimize transactions
    debtors.sort((a,b) => a.amount - b.amount); 
    creditors.sort((a,b) => b.amount - a.amount);

    const plan = [];
    let i = 0; 
    let j = 0; 

    while (i < debtors.length && j < creditors.length) {
      let debtor = debtors[i];
      let creditor = creditors[j];
      
      // Pay the minimum of what's owed vs what's received
      let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
      
      if (amount > 0.01) {
        plan.push({ from: debtor.name, to: creditor.name, amount: amount });
      }

      // Adjust temp balances
      debtor.amount += amount;
      creditor.amount -= amount;

      // Move indices if settled
      if (Math.abs(debtor.amount) < 0.01) i++;
      if (creditor.amount < 0.01) j++;
    }
    return plan;
  }, [settlement]);

  const handleExpenseSubmit = (e) => {
    e.preventDefault();
    if(!expenseForm.amount || !expenseForm.payerId) return;
    addExpense(expenseForm);
    setExpenseForm({ payerId: '', amount: '', description: '' });
  };

  const handleBetSubmit = (e) => {
    e.preventDefault();
    if(!betForm.amount || !betForm.winnerId || !betForm.loserId) return;
    addBet(betForm);
    setBetForm({ winnerId: '', loserId: '', amount: '', description: '' });
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
        <h2 className="text-2xl font-bold text-slate-800">The Ledger</h2>
        <div className="flex gap-2 text-sm bg-slate-100 p-1 rounded-lg w-fit">
          <button onClick={() => setView('summary')} className={`px-4 py-1.5 rounded-md ${view === 'summary' ? 'bg-white shadow text-slate-800 font-medium' : 'text-slate-500'}`}>Net Settlement</button>
          <button onClick={() => setView('log')} className={`px-4 py-1.5 rounded-md ${view === 'log' ? 'bg-white shadow text-slate-800 font-medium' : 'text-slate-500'}`}>Transaction Log</button>
        </div>
      </div>

      {view === 'summary' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="space-y-8">
            <div className="space-y-3">
              <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Net Positions</h3>
              {settlement.map(item => (
                <div key={item.id} className="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                  <div className="font-semibold text-slate-800">{item.name}</div>
                  <div className={`font-mono font-bold ${item.amount >= 0 ? 'text-emerald-600' : 'text-red-500'}`}>
                    {item.amount >= 0 ? '+' : ''}${item.amount.toFixed(2)}
                  </div>
                </div>
              ))}
            </div>

            <div className="space-y-3">
               <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Settlement Plan</h3>
               {payments.length > 0 ? (
                 payments.map((p, idx) => (
                   <div key={idx} className="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                     <div className="flex items-center gap-2 text-sm">
                        <span className="font-bold text-slate-700">{p.from}</span>
                        <span className="text-slate-400 text-xs">pays</span>
                        <span className="font-bold text-slate-700">{p.to}</span>
                     </div>
                     <div className="font-mono font-bold text-slate-600">
                       ${p.amount.toFixed(2)}
                     </div>
                   </div>
                 ))
               ) : (
                 <div className="text-slate-400 text-sm italic border border-dashed border-slate-300 rounded-xl p-4 text-center">No outstanding debts.</div>
               )}
            </div>
          </div>

          <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 h-fit">
            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
              <DollarSign className="w-5 h-5" /> Quick Actions
            </h3>
            
            <div className="space-y-6">
              {/* Add Expense Mini Form - Available to both roles */}
              <div>
                <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Log Shared Cost</label>
                <form onSubmit={handleExpenseSubmit} className="space-y-2">
                  <select 
                    className="w-full p-2 text-sm border rounded"
                    value={expenseForm.payerId}
                    onChange={e => setExpenseForm({...expenseForm, payerId: e.target.value})}
                  >
                    <option value="">Who Paid?</option>
                    {players.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
                  <div className="flex gap-2">
                    <input type="number" placeholder="Amount" className="w-1/3 p-2 text-sm border rounded" 
                      value={expenseForm.amount} onChange={e => setExpenseForm({...expenseForm, amount: e.target.value})} />
                    <input type="text" placeholder="Description (e.g. Dinner)" className="w-2/3 p-2 text-sm border rounded"
                      value={expenseForm.description} onChange={e => setExpenseForm({...expenseForm, description: e.target.value})} />
                  </div>
                  <button className="w-full bg-emerald-600 text-white text-sm py-2 rounded hover:bg-emerald-700">Add Shared Expense</button>
                </form>
              </div>

              <div className="border-t border-slate-200"></div>

              {/* Add Bet Mini Form - Available to both roles */}
              <div>
                <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Log Wager</label>
                <form onSubmit={handleBetSubmit} className="space-y-2">
                  <div className="flex gap-2">
                     <select className="w-1/2 p-2 text-sm border rounded" value={betForm.winnerId} onChange={e => setBetForm({...betForm, winnerId: e.target.value})}>
                        <option value="">Winner</option>
                        {players.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                     </select>
                     <select className="w-1/2 p-2 text-sm border rounded" value={betForm.loserId} onChange={e => setBetForm({...betForm, loserId: e.target.value})}>
                        <option value="">Loser</option>
                        {players.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                     </select>
                  </div>
                  <div className="flex gap-2">
                    <input type="number" placeholder="Amount" className="w-1/3 p-2 text-sm border rounded"
                      value={betForm.amount} onChange={e => setBetForm({...betForm, amount: e.target.value})} />
                    <input type="text" placeholder="Bet Details" className="w-2/3 p-2 text-sm border rounded"
                      value={betForm.description} onChange={e => setBetForm({...betForm, description: e.target.value})} />
                  </div>
                  <button className="w-full bg-slate-800 text-white text-sm py-2 rounded hover:bg-slate-700">Record Wager</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      )}

      {view === 'log' && (
        <div className="space-y-2">
          {expenses.map(e => (
            <div key={e.id} className="flex justify-between items-center bg-white p-3 rounded border border-slate-100">
              <div className="flex items-center gap-3">
                <div className="bg-emerald-100 text-emerald-600 p-2 rounded-lg"><DollarSign className="w-4 h-4"/></div>
                <div>
                   <p className="text-sm font-semibold text-slate-800">{e.description}</p>
                   <p className="text-xs text-slate-500">{players.find(p => p.id === e.payerId)?.name} paid for group</p>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <span className="font-mono font-bold text-slate-700">${e.amount}</span>
                {role === 'commissioner' && (
                  <button onClick={() => deleteItem('expenses', e.id)} className="text-slate-300 hover:text-red-500"><Trash2 className="w-4 h-4"/></button>
                )}
              </div>
            </div>
          ))}
          {bets.map(b => (
            <div key={b.id} className="flex justify-between items-center bg-white p-3 rounded border border-slate-100">
               <div className="flex items-center gap-3">
                <div className="bg-purple-100 text-purple-600 p-2 rounded-lg"><TrendingUp className="w-4 h-4"/></div>
                <div>
                   <p className="text-sm font-semibold text-slate-800">{b.description}</p>
                   <p className="text-xs text-slate-500">
                     <span className="text-emerald-600 font-medium">{players.find(p => p.id === b.winnerId)?.name}</span> took from <span className="text-red-500 font-medium">{players.find(p => p.id === b.loserId)?.name}</span>
                   </p>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <span className="font-mono font-bold text-slate-700">${b.amount}</span>
                {role === 'commissioner' && (
                  <button onClick={() => deleteItem('bets', b.id)} className="text-slate-300 hover:text-red-500"><Trash2 className="w-4 h-4"/></button>
                )}
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// 13. Dashboard
const Dashboard = ({ players, matches, itinerary, setView, role, teamNames }) => {
  const nextEvent = itinerary
    .filter(i => new Date(i.time) > new Date())
    .sort((a,b) => new Date(a.time) - new Date(b.time))[0];

  return (
    <div className="space-y-6">
      <div className="bg-emerald-900 rounded-2xl p-6 md:p-8 text-white relative overflow-hidden shadow-xl">
        <div className="relative z-10">
          <h2 className="text-3xl font-bold mb-2">
            {role === 'commissioner' ? 'Commissioner Dashboard' : 'Player Dashboard'}
          </h2>
          <p className="text-emerald-100 opacity-80 mb-6 max-w-lg">
            {role === 'commissioner' 
              ? "Welcome to the command center. Manage your roster, update match scores, and track expenses all from one place." 
              : "Welcome to the trip hub. Check your itinerary, view the live leaderboard, and settle up with the group."}
          </p>
          <div className="flex flex-wrap gap-3">
            <button onClick={() => setView('tournament')} className="bg-white text-emerald-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-emerald-50 transition-colors">
              {role === 'commissioner' ? 'Manage Scores' : 'View Leaderboard'}
            </button>
            <button onClick={() => setView('finance')} className="bg-emerald-800 text-white border border-emerald-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-emerald-700 transition-colors">
              Add Expense
            </button>
          </div>
        </div>
        <div className="absolute right-0 bottom-0 opacity-10 transform translate-x-12 translate-y-12">
          <Trophy className="w-64 h-64" />
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* Next Event Card */}
        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 order-2 md:order-none">
          <div className="flex items-center gap-2 mb-4">
             <div className="bg-orange-100 p-2 rounded-lg text-orange-600"><Calendar className="w-5 h-5" /></div>
             <h3 className="font-bold text-slate-700">Up Next</h3>
          </div>
          {nextEvent ? (
            <div>
              <div className="text-xs text-slate-500 uppercase font-bold tracking-wide mb-1">
                 {new Date(nextEvent.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
              </div>
              <div className="text-xl font-bold text-slate-800 leading-tight mb-2">{nextEvent.title}</div>
              <div className="text-sm text-slate-500">{nextEvent.location}</div>
            </div>
          ) : (
            <div className="text-slate-400 text-sm">No upcoming events scheduled.</div>
          )}
        </div>

        {/* Live Status */}
        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 order-3 md:order-none">
           <div className="flex items-center gap-2 mb-4">
             <div className="bg-blue-100 p-2 rounded-lg text-blue-600"><Activity className="w-5 h-5" /></div>
             <h3 className="font-bold text-slate-700">Active Matches</h3>
          </div>
          <div className="space-y-3">
             {matches.filter(m => m.winner === 'Pending').slice(0, 3).map(m => (
               <div key={m.id} className="text-sm border-b border-slate-100 pb-2 last:border-0">
                  <div className="flex justify-between mb-1">
                    <span className="font-semibold text-slate-700">{m.format}</span>
                    <span className="text-slate-500 text-xs">{m.status}</span>
                  </div>
                  <div className="flex justify-between text-xs text-slate-500">
                    <span>{m.redPlayers}</span>
                    <span>vs</span>
                    <span>{m.bluePlayers}</span>
                  </div>
               </div>
             ))}
             {matches.filter(m => m.winner === 'Pending').length === 0 && (
               <div className="text-slate-400 text-sm">All matches complete or none started.</div>
             )}
          </div>
        </div>
        
        {/* Quick Stats */}
        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 order-1 md:order-none">
           <div className="flex items-center gap-2 mb-4">
             <div className="bg-purple-100 p-2 rounded-lg text-purple-600"><Users className="w-5 h-5" /></div>
             <h3 className="font-bold text-slate-700">Roster Status</h3>
          </div>
          <div className="flex justify-between items-center text-center">
            <div>
              <div className="text-2xl font-bold text-slate-800">{players.length}</div>
              <div className="text-xs text-slate-500">Players</div>
            </div>
             <div>
              <div className="text-2xl font-bold text-red-600">{players.filter(p => p.team === 'Red').length}</div>
              <div className="text-xs text-slate-500 truncate px-1">{teamNames.red}</div>
            </div>
             <div>
              <div className="text-2xl font-bold text-blue-600">{players.filter(p => p.team === 'Blue').length}</div>
              <div className="text-xs text-slate-500 truncate px-1">{teamNames.blue}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};


// --- Main App Container ---
const App = () => {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('setup'); // Default to setup
  const [loading, setLoading] = useState(true);
  const [role, setRole] = useState('player'); 
  const [tripId, setTripId] = useState(null); // Active Trip Context
  const [isSubscribed, setIsSubscribed] = useState(false); // New subscription state

  // Data States
  const [players, setPlayers] = useState([]);
  const [matches, setMatches] = useState([]);
  const [itinerary, setItinerary] = useState([]);
  const [expenses, setExpenses] = useState([]);
  const [bets, setBets] = useState([]);
  const [teamNames, setTeamNames] = useState({ red: 'Red Team', blue: 'Blue Team' });

  // Auth & Initial Load
  useEffect(() => {
    const initAuth = async () => {
      try {
        console.log("Starting auth init...");
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          console.log("Signing in with custom token");
          await signInWithCustomToken(auth, __initial_auth_token);
        } 
        // We removed signInAnonymously auto-login here to force Login Screen
        // If no token, user remains null, and AuthScreen shows.
      } catch (error) {
        console.error("Auth Initialization Error:", error);
      } finally {
        // Stop loading spinner if we aren't waiting on a token
        if (typeof __initial_auth_token === 'undefined' || !__initial_auth_token) {
           // We might want to keep loading false so AuthScreen renders
        }
      }
    };
    initAuth();
    
    // Listen for Auth Changes
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      if (currentUser) {
        console.log("User Authenticated:", currentUser.uid);
        setUser(currentUser);
      } else {
        console.log("User signed out.");
        setUser(null);
      }
      setLoading(false); // Auth check done
    });
    return () => unsubscribe();
  }, []);

  const handleLogout = async () => {
    await auth.signOut();
    setUser(null);
    setTripId(null);
    setView('setup');
    setIsSubscribed(false);
  };

  // Subscription Status Sync (User specific)
  useEffect(() => {
    if (!user) {
      setIsSubscribed(false);
      return;
    }

    const validAppId = typeof appId === 'string' ? appId : 'default-app-id';
    const unsubUser = onSnapshot(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.USERS, user.uid), (doc) => {
      if (doc.exists() && doc.data().isPro) {
        setIsSubscribed(true);
      } else {
        setIsSubscribed(false);
      }
    });
    return () => unsubUser();
  }, [user]);

  // Data Sync - Filters by TripID
  useEffect(() => {
    if (!user || !tripId) {
      return;
    }
    
    console.log(`Starting data sync for App ID: ${appId}, Trip ID: ${tripId}`);

    // Ensure appId is a string to prevent path errors
    const validAppId = typeof appId === 'string' ? appId : 'default-app-id';
    const getCol = (name) => collection(db, 'artifacts', validAppId, 'public', 'data', name);

    const unsubPlayers = onSnapshot(getCol(COLLECTIONS.PLAYERS), (snap) => {
      setPlayers(snap.docs.map(d => ({id: d.id, ...d.data()})).filter(d => d.tripId === tripId));
    }, (err) => console.error("Players sync error:", err));

    const unsubMatches = onSnapshot(getCol(COLLECTIONS.MATCHES), (snap) => {
      const matchData = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(d => d.tripId === tripId);
      matchData.sort((a, b) => (a.day || '').localeCompare(b.day || ''));
      setMatches(matchData);
    }, (err) => console.error("Matches sync error:", err));

    const unsubItinerary = onSnapshot(getCol(COLLECTIONS.ITINERARY), (snap) => {
      setItinerary(snap.docs.map(d => ({id: d.id, ...d.data()})).filter(d => d.tripId === tripId));
    }, (err) => console.error("Itinerary sync error:", err));

    const unsubExpenses = onSnapshot(getCol(COLLECTIONS.EXPENSES), (snap) => {
      setExpenses(snap.docs.map(d => ({id: d.id, ...d.data()})).filter(d => d.tripId === tripId));
    }, (err) => console.error("Expenses sync error:", err));
    
    const unsubBets = onSnapshot(getCol(COLLECTIONS.BETS), (snap) => {
      setBets(snap.docs.map(d => ({id: d.id, ...d.data()})).filter(d => d.tripId === tripId));
    }, (err) => console.error("Bets sync error:", err));

    const unsubSettings = onSnapshot(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.SETTINGS, 'config'), (doc) => {
      if (doc.exists()) {
        setTeamNames(doc.data());
      }
    }, (err) => {
       console.log("Settings sync status:", err.code);
    });

    return () => {
      unsubPlayers();
      unsubMatches();
      unsubItinerary();
      unsubExpenses();
      unsubBets();
      unsubSettings();
    };
  }, [user, tripId]);

  // Actions - Injects TripID
  const validAppId = typeof appId === 'string' ? appId : 'default-app-id';
  const getCol = (name) => collection(db, 'artifacts', validAppId, 'public', 'data', name);

  const addPlayer = async (data) => await addDoc(getCol(COLLECTIONS.PLAYERS), { ...data, tripId });
  const deletePlayer = async (id) => await deleteDoc(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.PLAYERS, id));
  const updatePlayer = async (id, data) => await updateDoc(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.PLAYERS, id), data);

  const addMatch = async (data) => await addDoc(getCol(COLLECTIONS.MATCHES), { ...data, tripId });
  const updateMatch = async (id, data) => await updateDoc(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.MATCHES, id), data);
  const deleteMatch = async (id) => await deleteDoc(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.MATCHES, id));

  const addItinerary = async (data) => await addDoc(getCol(COLLECTIONS.ITINERARY), { ...data, tripId });
  const deleteItinerary = async (id) => await deleteDoc(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.ITINERARY, id));

  const addExpense = async (data) => await addDoc(getCol(COLLECTIONS.EXPENSES), { ...data, tripId });
  const addBet = async (data) => await addDoc(getCol(COLLECTIONS.BETS), { ...data, tripId });
  const deleteLedgerItem = async (colName, id) => {
     const collectionName = colName === 'expenses' ? COLLECTIONS.EXPENSES : COLLECTIONS.BETS;
     await deleteDoc(doc(db, 'artifacts', validAppId, 'public', 'data', collectionName, id));
  };

  const updateTeamNames = async (names) => {
    await setDoc(doc(db, 'artifacts', validAppId, 'public', 'data', COLLECTIONS.SETTINGS, 'config'), names, { merge: true });
  };

  if (loading) return <div className="h-screen flex items-center justify-center bg-slate-900 text-emerald-500 font-bold">Loading Fairway Commissioner...</div>;

  // Render AuthScreen if no user
  if (!user) {
    return <AuthScreen />;
  }

  return (
    <Layout 
      view={view} 
      setView={setView} 
      user={user} 
      role={role} 
      setRole={setRole}
      tripId={tripId}
      setTripId={setTripId}
      handleLogout={handleLogout}
    >
      {view === 'setup' && (
        <TripSetupView 
          setTripId={setTripId} 
          setRole={setRole} 
          setView={setView} 
          user={user} 
          isSubscribed={isSubscribed} 
        />
      )}
      {view === 'profile' && (
        <UserProfileView 
          user={user}
          isSubscribed={isSubscribed}
        />
      )}
      {tripId && view !== 'profile' && (
        <>
          {view === 'dashboard' && <Dashboard players={players} matches={matches} itinerary={itinerary} setView={setView} role={role} teamNames={teamNames} />}
          {view === 'players' && <RosterView players={players} addPlayer={addPlayer} deletePlayer={deletePlayer} updatePlayer={updatePlayer} role={role} teamNames={teamNames} />}
          {view === 'tournament' && <TournamentView players={players} matches={matches} updateMatch={updateMatch} addMatch={addMatch} deleteMatch={deleteMatch} role={role} teamNames={teamNames} updateTeamNames={updateTeamNames} />}
          {view === 'booking' && <BookRoundsView />}
          {view === 'travel' && <StaysTransportView />}
          {view === 'merch' && <TeamMerchView />}
          {view === 'logistics' && <LogisticsView itinerary={itinerary} addItinerary={addItinerary} deleteItinerary={deleteItinerary} role={role} />}
          {view === 'finance' && <LedgerView players={players} expenses={expenses} bets={bets} addExpense={addExpense} addBet={addBet} deleteItem={deleteLedgerItem} role={role} />}
        </>
      )}
    </Layout>
  );
};

export default App;